<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">
                            <i class="fas fa-percentage me-2"></i>Gestión de Descuentos
                        </h2>
                        <button class="btn btn-primary" (click)="showCreateForm()">
                            <i class="fas fa-plus me-1"></i>Crear Descuento
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Estadísticas -->
                    <div class="row mb-4">
                        <div class="col-md-2">
                            <div class="stat-card bg-primary text-white">
                                <div class="stat-icon">
                                    <i class="fas fa-tags"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>{{ stats.totalDiscounts }}</h4>
                                    <p>Total Descuentos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card bg-success text-white">
                                <div class="stat-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>{{ stats.activeDiscounts }}</h4>
                                    <p>Activos</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card bg-info text-white">
                                <div class="stat-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>{{ stats.totalUsage }}</h4>
                                    <p>Usos Totales</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card bg-warning text-white">
                                <div class="stat-icon">
                                    <i class="fas fa-folder"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>{{ stats.categoryDiscounts }}</h4>
                                    <p>Por Categoría</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="stat-card bg-danger text-white">
                                <div class="stat-icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <h4>{{ stats.couponDiscounts }}</h4>
                                    <p>Cupones</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Descuentos -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>
                                        <i class="fas fa-tag me-1"></i>Tipo
                                    </th>
                                    <th>
                                        <i class="fas fa-align-left me-1"></i>Descripción
                                    </th>
                                    <th>
                                        <i class="fas fa-percentage me-1"></i>Valor
                                    </th>
                                    <th>
                                        <i class="fas fa-calendar me-1"></i>Fechas
                                    </th>
                                    <th>
                                        <i class="fas fa-toggle-on me-1"></i>Estado
                                    </th>
                                    <th>
                                        <i class="fas fa-chart-bar me-1"></i>Uso
                                    </th>
                                    <th>
                                        <i class="fas fa-cog me-1"></i>Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let discount of discounts">
                                    <td>
                                        <span class="badge" [ngClass]="{
                      'bg-primary': discount.type === 'percentage',
                      'bg-success': discount.type === 'fixed',
                      'bg-warning': discount.type === 'category',
                      'bg-danger': discount.type === 'coupon'
                    }">
                                            {{ getDiscountTypeLabel(discount.type) }}
                                        </span>
                                        <small class="d-block text-muted" *ngIf="discount.category">
                                            {{ discount.category }}
                                        </small>
                                        <small class="d-block text-muted" *ngIf="discount.couponCode">
                                            {{ discount.couponCode }}
                                        </small>
                                    </td>
                                    <td>
                                        <strong>{{ discount.description }}</strong>
                                        <div class="discount-details">
                                            <small class="text-muted" *ngIf="discount.minPurchase">
                                                Mín: ${{ discount.minPurchase }}
                                            </small>
                                            <small class="text-muted" *ngIf="discount.maxDiscount">
                                                Máx: ${{ discount.maxDiscount }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="discount-value">
                                            {{ discount.value }}{{ discount.type === 'percentage' ? '%' : '$' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="date-info">
                                            <small class="d-block">
                                                <i class="fas fa-play text-success"></i>
                                                {{ formatDate(discount.startDate) }}
                                            </small>
                                            <small class="d-block">
                                                <i class="fas fa-stop text-danger"></i>
                                                {{ formatDate(discount.endDate) }}
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span [class]="getDiscountStatusClass(discount)">
                                            {{ getDiscountStatusText(discount) }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="usage-info">
                                            <span [class]="getUsageClass(discount)">
                                                {{ discount.usedCount }}/{{ discount.usageLimit || '∞' }}
                                            </span>
                                            <div class="progress mt-1" *ngIf="discount.usageLimit">
                                                <div class="progress-bar"
                                                    [class]="getUsageClass(discount).replace('text-', 'bg-')"
                                                    [style.width.%]="getUsagePercentage(discount)"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-warning btn-sm" (click)="showEditForm(discount)"
                                                title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn"
                                                [class]="discount.isActive ? 'btn-secondary' : 'btn-success'"
                                                (click)="toggleDiscountStatus(discount)"
                                                [title]="discount.isActive ? 'Desactivar' : 'Activar'">
                                                <i class="fas" [class]="discount.isActive ? 'fa-pause' : 'fa-play'"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm" (click)="deleteDiscount(discount)"
                                                title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Mensaje cuando no hay descuentos -->
                    <div class="text-center py-5" *ngIf="discounts.length === 0 && !loading">
                        <i class="fas fa-percentage fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No hay descuentos configurados</h4>
                        <p class="text-muted">Crea tu primer descuento para empezar a promocionar tus productos.</p>
                        <button class="btn btn-primary" (click)="showCreateForm()">
                            <i class="fas fa-plus me-1"></i>Crear Descuento
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Formulario -->
    <div class="modal fade show" [class.d-block]="showForm" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-percentage me-2"></i>
                        {{ editingDiscount ? 'Editar Descuento' : 'Crear Nuevo Descuento' }}
                    </h5>
                    <button type="button" class="btn-close" (click)="closeForm()"></button>
                </div>

                <form [formGroup]="discountForm" (ngSubmit)="onSubmit()">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="type" class="form-label">
                                        <i class="fas fa-tag me-1"></i>Tipo de Descuento *
                                    </label>
                                    <select id="type" class="form-select"
                                        [class.is-invalid]="discountForm.get('type')?.invalid && discountForm.get('type')?.touched"
                                        formControlName="type">
                                        <option value="">Seleccionar tipo</option>
                                        <option *ngFor="let type of discountTypes" [value]="type.value">
                                            {{ type.label }}
                                        </option>
                                    </select>
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('type')">
                                        {{ getErrorMessage('type') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="value" class="form-label">
                                        <i class="fas fa-percentage me-1"></i>Valor *
                                    </label>
                                    <input id="value" type="number" class="form-control"
                                        [class.is-invalid]="discountForm.get('value')?.invalid && discountForm.get('value')?.touched"
                                        formControlName="value"
                                        [placeholder]="discountForm.get('type')?.value === 'percentage' ? '0-100' : '0.00'" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('value')">
                                        {{ getErrorMessage('value') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-group mb-3">
                                    <label for="description" class="form-label">
                                        <i class="fas fa-align-left me-1"></i>Descripción *
                                    </label>
                                    <input id="description" type="text" class="form-control"
                                        [class.is-invalid]="discountForm.get('description')?.invalid && discountForm.get('description')?.touched"
                                        formControlName="description" placeholder="Descripción del descuento" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('description')">
                                        {{ getErrorMessage('description') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6" *ngIf="discountForm.get('type')?.value === 'category'">
                                <div class="form-group mb-3">
                                    <label for="category" class="form-label">
                                        <i class="fas fa-folder me-1"></i>Categoría *
                                    </label>
                                    <select id="category" class="form-select"
                                        [class.is-invalid]="discountForm.get('category')?.invalid && discountForm.get('category')?.touched"
                                        formControlName="category">
                                        <option value="">Seleccionar categoría</option>
                                        <option *ngFor="let category of categories" [value]="category">
                                            {{ category }}
                                        </option>
                                    </select>
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('category')">
                                        {{ getErrorMessage('category') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6" *ngIf="discountForm.get('type')?.value === 'coupon'">
                                <div class="form-group mb-3">
                                    <label for="couponCode" class="form-label">
                                        <i class="fas fa-ticket-alt me-1"></i>Código de Cupón *
                                    </label>
                                    <input id="couponCode" type="text" class="form-control"
                                        [class.is-invalid]="discountForm.get('couponCode')?.invalid && discountForm.get('couponCode')?.touched"
                                        formControlName="couponCode" placeholder="Ej: WELCOME10" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('couponCode')">
                                        {{ getErrorMessage('couponCode') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="startDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Fecha de Inicio
                                    </label>
                                    <input id="startDate" type="date" class="form-control"
                                        formControlName="startDate" />
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="endDate" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Fecha de Fin
                                    </label>
                                    <input id="endDate" type="date" class="form-control"
                                        [class.is-invalid]="discountForm.get('endDate')?.invalid && discountForm.get('endDate')?.touched"
                                        formControlName="endDate" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('endDate')">
                                        {{ getErrorMessage('endDate') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="minPurchase" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Compra Mínima
                                    </label>
                                    <input id="minPurchase" type="number" step="0.01" class="form-control"
                                        [class.is-invalid]="discountForm.get('minPurchase')?.invalid && discountForm.get('minPurchase')?.touched"
                                        formControlName="minPurchase" placeholder="0.00" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('minPurchase')">
                                        {{ getErrorMessage('minPurchase') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="maxDiscount" class="form-label">
                                        <i class="fas fa-dollar-sign me-1"></i>Descuento Máximo
                                    </label>
                                    <input id="maxDiscount" type="number" step="0.01" class="form-control"
                                        [class.is-invalid]="discountForm.get('maxDiscount')?.invalid && discountForm.get('maxDiscount')?.touched"
                                        formControlName="maxDiscount" placeholder="0.00" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('maxDiscount')">
                                        {{ getErrorMessage('maxDiscount') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="usageLimit" class="form-label">
                                        <i class="fas fa-users me-1"></i>Límite de Uso
                                    </label>
                                    <input id="usageLimit" type="number" class="form-control"
                                        [class.is-invalid]="discountForm.get('usageLimit')?.invalid && discountForm.get('usageLimit')?.touched"
                                        formControlName="usageLimit" placeholder="0 (sin límite)" />
                                    <div class="invalid-feedback" *ngIf="getErrorMessage('usageLimit')">
                                        {{ getErrorMessage('usageLimit') }}
                                    </div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input id="isActive" class="form-check-input" type="checkbox"
                                        formControlName="isActive" />
                                    <label class="form-check-label" for="isActive">
                                        <i class="fas fa-toggle-on me-1"></i>Descuento Activo
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeForm()">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" [disabled]="discountForm.invalid">
                            <i class="fas fa-save me-1"></i>
                            {{ editingDiscount ? 'Actualizar' : 'Crear' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Overlay del modal -->
    <div class="modal-backdrop fade show" *ngIf="showForm"></div>
</div>